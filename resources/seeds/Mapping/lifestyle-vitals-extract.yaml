id: lifestyle-vitals-extract
type: FHIRPath
resourceType: Mapping
body:
  "{% assign %}":
    - patientId: "{{ %QuestionnaireResponse.answers('patient-id') }}"
    - dateTime: "{{ %QuestionnaireResponse.answers('date-time') }}"
    - smokingStatus: "{{ %QuestionnaireResponse.answers('smoking-status') }}"
    - height: "{{ %QuestionnaireResponse.answers('height') }}"
    - weight: "{{ %QuestionnaireResponse.answers('weight') }}"
    - bmi: "{{ %QuestionnaireResponse.answers('bmi') }}"
  resourceType: Bundle
  type: transaction
  entry:
    # Smoking Status Observation
    - request:
        url: "Observation"
        method: POST
      resource:
        resourceType: Observation
        status: final
        category:
          - coding:
              - system: http://terminology.hl7.org/CodeSystem/observation-category
                code: social-history
                display: Social History
        code:
          coding:
            - system: http://loinc.org
              code: "72166-2"
              display: "Tobacco smoking status"
        subject:
          reference: "Patient/{{ %patientId }}"
        effectiveDateTime: "{{ %dateTime }}"
        valueCodeableConcept: 
          coding:
            - "{{ %smokingStatus }}"

    # Body Height Observation
    - request:
        url: "Observation"
        method: POST
      resource:
        resourceType: Observation
        status: final
        category:
          - coding:
              - system: http://terminology.hl7.org/CodeSystem/observation-category
                code: vital-signs
                display: Vital Signs
        code:
          coding:
            - system: http://loinc.org
              code: "8302-2"
              display: "Body height"
        subject:
          reference: "Patient/{{ %patientId }}"
        effectiveDateTime: "{{ %dateTime }}"
        valueQuantity: "{{ %height }}"

    # Body Weight Observation
    - request:
        url: "Observation"
        method: POST
      resource:
        resourceType: Observation
        status: final
        category:
          - coding:
              - system: http://terminology.hl7.org/CodeSystem/observation-category
                code: vital-signs
                display: Vital Signs
        code:
          coding:
            - system: http://loinc.org
              code: "29463-7"
              display: "Body weight"
        subject:
          reference: "Patient/{{ %patientId }}"
        effectiveDateTime: "{{ %dateTime }}"
        valueQuantity: "{{ %weight }}"

    # BMI Observation
    - request:
        url: "Observation"
        method: POST
      resource:
        resourceType: Observation
        status: final
        category:
          - coding:
              - system: http://terminology.hl7.org/CodeSystem/observation-category
                code: vital-signs
                display: Vital Signs
        code:
          coding:
            - system: http://loinc.org
              code: "39156-5"
              display: "Body mass index (BMI) [Ratio]"
        subject:
          reference: "Patient/{{ %patientId }}"
        effectiveDateTime: "{{ %dateTime }}"
        valueQuantity:
          value: "{{ %bmi }}"
          unit: "kg/m2"
          system: "http://unitsofmeasure.org"
          code: "kg/m2"