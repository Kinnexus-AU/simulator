id: lifestyle-vitals-extract
type: FHIRPath
resourceType: Mapping
body:
  "{% assign %}":
    - patientId: "{{ %QuestionnaireResponse.answers('patient-id') }}"
    - dateTime: "{{ %QuestionnaireResponse.answers('date-time') }}"
    - smokingStatus: "{{ %QuestionnaireResponse.answers('smoking-status') }}"
    - height: "{{ %QuestionnaireResponse.answers('height') }}"
    - weight: "{{ %QuestionnaireResponse.answers('weight') }}"
  resourceType: Bundle
  type: transaction
  entry:
    # Smoking Status Observation
    #- request:
    #    url: "Observation"
    #    method: POST
    #  resource:
    #    resourceType: Observation
    #    meta:
    #      profile:
    #        - http://hl7.org.au/fhir/core/StructureDefinition/au-core-smokingstatus
    #    status: final
    #    category:
    #      - coding:
    #          - system: http://terminology.hl7.org/CodeSystem/observation-category
    #            code: social-history
    #            display: Social History
    #    code:
    #      coding:
    #        - system: http://snomed.info/sct
    #          code: "1747861000168109"
    #          display: "Tobacco smoking status"
    #        - system: http://loinc.org
    #          code: "72166-2"
    #          display: "Tobacco smoking status"
    #    subject:
    #      reference: "Patient/{{ %patientId }}"
    #    effectiveDateTime: "{{ %dateTime }}"
    #    valueCodeableConcept: 
    #      coding:
    #        - "{{ %smokingStatus }}"
    # Body Height Observation
    - request:
        url: "Observation"
        method: POST
      resource:
        resourceType: Observation
        meta:
          profile:
            - http://hl7.org.au/fhir/core/StructureDefinition/au-core-bodyheight
        status: final
        category:
          - coding:
              - system: http://terminology.hl7.org/CodeSystem/observation-category
                code: vital-signs
                display: Vital Signs
        code:
          coding:
            - system: http://snomed.info/sct
              code: "50373000"
              display: "Body height"
            - system: http://loinc.org
              code: "8302-2"
              display: "Body height"              
        subject:
          reference: "Patient/{{ %patientId }}"
        effectiveDateTime: "{{ %dateTime }}"
        valueQuantity: "{{ %height }}"

    # Body Weight Observation
    - request:
        url: "Observation"
        method: POST
      resource:
        resourceType: Observation
        meta:
          profile:
            - http://hl7.org.au/fhir/core/StructureDefinition/au-core-bodyweight
        status: final
        category:
          - coding:
              - system: http://terminology.hl7.org/CodeSystem/observation-category
                code: vital-signs
                display: Vital Signs
        code:
          coding:
            - system: http://snomed.info/sct
              code: "27113001"
              display: "Body weight"
            - system: http://loinc.org
              code: "29463-7"
              display: "Body weight"              
        subject:
          reference: "Patient/{{ %patientId }}"
        effectiveDateTime: "{{ %dateTime }}"
        valueQuantity: "{{ %weight }}"
