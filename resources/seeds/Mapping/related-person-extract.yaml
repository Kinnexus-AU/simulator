id: related-person-extract
type: FHIRPath
resourceType: Mapping
body:
  "{% assign %}":
    - patientId: "{{ %QuestionnaireResponse.answers('patient-id') }}"
    - firstName: "{{ %QuestionnaireResponse.answers('related-person-first-name') }}"
    - lastName: "{{ %QuestionnaireResponse.answers('related-person-last-name') }}"
  resourceType: Bundle
  type: transaction
  entry:
    - "{% for relatedPersonGroup in %QuestionnaireResponse.item.where(linkId='related-person-group') %}":
        request:
          url: /RelatedPerson
          method: POST
        resource:
          resourceType: RelatedPerson
          meta:
            profile:
              - http://hl7.org.au/fhir/core/StructureDefinition/au-core-relatedperson
          patient:
            reference: "Patient/{{ %patientId }}"
          relationship:
              - coding:
                  - "{{ %relatedPersonGroup.item.where(linkId='relationship-type').answer.valueCoding }}"
          name:
            - given:
                - "{{ %relatedPersonGroup.item.where(linkId='related-person-first-name').answer.valueString }}"
              family: "{{ %relatedPersonGroup.item.where(linkId='related-person-last-name').answer.valueString }}"