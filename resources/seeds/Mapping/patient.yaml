id: patient
type: FHIRPath
resourceType: Mapping
body:
  type: transaction
  entry:
    - fullUrl: "{{ 'urn:uuid:patient-id' }}"
      request:
        "{% else %}":
          url: /Patient
          method: POST
        "{% if %patientId.exists() %}":
          url: /Patient/{{ %patientId }}
          method: PUT
      resource:
        name:
          - given:
              - "{{ %firstName }}"
              - "{{ %middleName }}"
            family: "{{ %lastName }}"
            prefix:
              - "{{ %title }}"
        active: true
        gender: "{{ %gender.code }}"
        birthDate: "{{ %birthDate }}"
        identifier:
          - type: 
              coding:
                - system: http://terminology.hl7.org/CodeSystem/v2-0203
                  code: MC
            system: http://ns.electronichealth.net.au/id/medicare-number
            value: "{{ %medicareNumber }}"
          - type:
              coding:
                - system: http://terminology.hl7.org/CodeSystem/v2-0203
                  code: MR
            system: http://www.acme.com/identifiers/patient
            value: "{{ %medicalRecordNumber }}"
        extension:
          - "{% if %genderIdentity.exists() %}":
              - url: "http://hl7.org/fhir/StructureDefinition/individual-genderIdentity"
                extension:
                  - url: "value"
                    valueCodeableConcept:
                      coding:
                        - "{{ %genderIdentity }}"
                  - "{% if %selfIdentifiedGender.exists() %}":
                      url: "comment"
                      valueString: "{{ %selfIdentifiedGender }}"
          - "{% if %birthPlace.exists() %}":
              - url: "http://hl7.org/fhir/StructureDefinition/patient-birthPlace"
                valueAddress:
                  text: "{{ %birthPlace }}"
          - "{% if %indigenousStatus.exists() %}":
              - url: "http://hl7.org.au/fhir/StructureDefinition/indigenous-status"
                valueCoding: 
                  '{% assign %}':
                    displayValue:
                      - "{% if %indigenousStatus.code = '1' %}": Aboriginal but not Torres Strait Islander origin
                      - "{% if %indigenousStatus.code = '2' %}": Torres Strait Islander but not Aboriginal origin
                      - "{% if %indigenousStatus.code = '3' %}": Both Aboriginal and Torres Strait Islander origin
                      - "{% if %indigenousStatus.code = '4' %}": Neither Aboriginal nor Torres Strait Islander origin
                  code: '{{ %indigenousStatus.code }}'
                  system: '{{ %indigenousStatus.system }}'
                  display: '{{ %displayValue }}'
        "{% if %maritalStatus.exists() %}":
          maritalStatus: 
            coding:
              - "{{ %maritalStatus }}"
        resourceType: Patient
        meta:
          profile:
            - http://hl7.org.au/fhir/core/StructureDefinition/au-core-patient
  resourceType: Bundle
  "{% assign %}":
    - patientId: "{{ %QuestionnaireResponse.answers('patient-id') }}"
    - firstName: "{{ %QuestionnaireResponse.answers('first-name') }}"
    - middleName: "{{ %QuestionnaireResponse.answers('middle-name') }}"
    - lastName: "{{ %QuestionnaireResponse.answers('last-name') }}"
    - title: "{{ %QuestionnaireResponse.answers('title') }}"
    - gender: "{{ %QuestionnaireResponse.answers('gender') }}"
    - genderIdentity: "{{ %QuestionnaireResponse.answers('gender-identity') }}"
    - selfIdentifiedGender: "{{ %QuestionnaireResponse.answers('self-identified-gender') }}"
    - birthDate: "{{ %QuestionnaireResponse.answers('birthdate') }}"
    - maritalStatus: "{{ %QuestionnaireResponse.answers('marital-status') }}"
    - birthPlace: "{{ %QuestionnaireResponse.answers('birth-place') }}"
    - indigenousStatus: "{{ %QuestionnaireResponse.answers('indigenous-status') }}"
    - medicareNumber: "{{ %QuestionnaireResponse.answers('medicare-number') }}"
    - medicalRecordNumber: "{{ %QuestionnaireResponse.answers('patient-record-number') }}"

