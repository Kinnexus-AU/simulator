id: patient
type: FHIRPath
resourceType: Mapping
body:
  type: transaction
  entry:
    - fullUrl: "{{ 'urn:uuid:patient-id' }}"
      request:
        "{% else %}":
          url: /Patient
          method: POST
        "{% if %patientId.exists() %}":
          url: /Patient/{{ %patientId }}
          method: PUT
      resource:
        name:
          - given:
              - "{{ %firstName }}"
              - "{{ %middleName }}"
            family: "{{ %lastName }}"
            prefix:
              - "{{ %title }}"
        active: true
        gender: "{{ %gender.code }}"
        birthDate: "{{ %birthDate }}"
        identifier:
          - system: test
            value: test
        extension:
          - "{% if %genderIdentity.exists() %}":
              - url: "http://hl7.org/fhir/StructureDefinition/individual-genderIdentity"
                extension:
                  - url: "value"
                    valueCodeableConcept:
                      coding:
                        - "{{ %genderIdentity }}"
                      "{% if %genderIdentitySpecify.exists() %}":
                        text: "{{ %genderIdentitySpecify }}"
          - "{% if %countryOfBirth.exists() %}":
              - url: "http://hl7.org/fhir/StructureDefinition/patient-birthPlace"
                valueAddress:
                  text: "{{ %countryOfBirth }}"
          - "{% if %indigenousStatus.exists() %}":
              - url: "http://hl7.org.au/fhir/StructureDefinition/indigenous-status"
                valueCoding: "{{ %indigenousStatus }}"
        "{% if %maritalStatus.exists() %}":
          maritalStatus: 
            coding:
              - "{{ %maritalStatus }}"
        resourceType: Patient
        meta:
          profile:
            - http://hl7.org.au/fhir/core/StructureDefinition/au-core-patient
  resourceType: Bundle
  "{% assign %}":
    - patientId: "{{ %QuestionnaireResponse.answers('patient-id') }}"
    - firstName: "{{ %QuestionnaireResponse.answers('iA1a') }}"
    - middleName: "{{ %QuestionnaireResponse.answers('iA1b') }}"
    - lastName: "{{ %QuestionnaireResponse.answers('iA1c') }}"
    - title: "{{ %QuestionnaireResponse.answers('iA1d') }}"
    - gender: "{{ %QuestionnaireResponse.answers('iA2c') }}"
    - genderIdentity: "{{ %QuestionnaireResponse.answers('iA2d') }}"
    - genderIdentitySpecify: "{{ %QuestionnaireResponse.answers('iA2e') }}"
    - birthDate: "{{ %QuestionnaireResponse.answers('iA3') }}"
    - maritalStatus: "{{ %QuestionnaireResponse.answers('iA4') }}"
    - countryOfBirth: "{{ %QuestionnaireResponse.answers('iA45') }}"
    - indigenousStatus: "{{ %QuestionnaireResponse.answers('iB3k') }}"
